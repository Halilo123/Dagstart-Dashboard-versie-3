<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dagstart Dashboard</title>
  <style>
    :root{
      --bg:#0b1220;
      --border:rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(255,255,255,.08);
      --shadow: 0 10px 28px rgba(0,0,0,.30);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 700px at 20% 5%, rgba(59,130,246,.20), transparent 55%),
                  radial-gradient(900px 600px at 80% 10%, rgba(34,197,94,.14), transparent 55%),
                  radial-gradient(1000px 700px at 40% 100%, rgba(245,158,11,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{max-width: 1550px; margin:0 auto; padding:16px;}
    @media(min-width:900px){ .wrap{padding:26px;} }

    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:flex-start; gap:12px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(34,197,94,.75));
      box-shadow: var(--shadow);
      border:1px solid var(--border);
    }
    h1{margin:0; font-size: 22px; letter-spacing:-.02em;}
    .sub{margin:2px 0 0 0; color:var(--muted); font-size: 13px;}

    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius: 999px; background: var(--chip);
      border: 1px solid var(--border);
      font-size: 13px; color: var(--text);
    }
    .dot{width:9px; height:9px; border-radius:99px; background: rgba(255,255,255,.35);}
    .dot.good{background: var(--good);}
    .dot.warn{background: var(--warn);}
    .dot.bad{background: var(--bad);}

    .btnrow{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      font-weight: 650;
      cursor:pointer;
    }
    button:hover{background: rgba(255,255,255,.10);}
    button.primary{
      background: rgba(59,130,246,.18);
      border-color: rgba(59,130,246,.35);
    }
    button.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }
    .miniBtns{display:flex; gap:8px; flex-wrap:wrap;}
    .mini{
      padding:7px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-family: var(--mono);
    }

    .grid{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width:1150px){
      .grid{ grid-template-columns: 1.25fr .75fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-h{
      padding:14px 16px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.12);
    }
    .panel h2{margin:0; font-size: 16px;}
    .hint{color: var(--muted); font-size: 12px; margin-top:3px;}
    .panel-b{padding:14px 16px;}

    .kpi{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
    }
    @media(min-width:700px){
      .kpi{grid-template-columns: repeat(3, 1fr);}
    }
    .tile{
      background: rgba(0,0,0,.15);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding:12px 12px;
      min-height:86px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .tile .label{color: var(--muted); font-size: 12px;}
    .tile .value{font-size: 22px; font-weight: 800; letter-spacing:-.02em; margin-top:6px;}
    .tile .small{color: var(--muted); font-size: 12px; margin-top:6px;}
    .tile.good{border-color: rgba(34,197,94,.35);}
    .tile.warn{border-color: rgba(245,158,11,.35);}
    .tile.bad{border-color: rgba(239,68,68,.35);}

    .twoCol{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width:900px){
      .twoCol{grid-template-columns: 1fr 1fr;}
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      background: rgba(0,0,0,.15);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding: 10px 12px;
      display:flex;
      gap:12px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .item .left{min-width:0;}
    .item .title{font-weight:700; margin:0; font-size: 14px;}
    .item .meta{margin:4px 0 0 0; color: var(--muted); font-size: 12px;}

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      padding:6px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(34,197,94,.35);}
    .badge.warn{border-color: rgba(245,158,11,.35);}
    .badge.bad{border-color: rgba(239,68,68,.35);}

    .editor{
      display:none;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border);
    }
    .editor.on{display:block;}
    textarea, input[type="text"], input[type="number"], input[type="date"], select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:10px 12px;
      font-size: 14px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical;}
    label{display:block; color: var(--muted); font-size: 12px; margin-bottom:6px;}
    .formgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:700px){ .formgrid{ grid-template-columns: 1fr 1fr; } }

    table{width:100%; border-collapse:separate; border-spacing:0 10px;}
    .trow{
      background: rgba(0,0,0,.15);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      overflow:hidden;
    }
    .trow td, .trow th{
      padding:10px 10px;
      font-size:13px;
      white-space:nowrap;
    }
    .trow td:nth-child(1){font-weight:700;}
    .twrap{overflow:auto;}

    .footer{
      margin-top:14px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .linklike{opacity:.9; text-decoration:underline; cursor:pointer;}

    .serviceHint{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }
    .search{
      display:flex; gap:10px; align-items:center;
      margin-top:10px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1 id="title">Dagstart Dashboard</h1>
          <p class="sub" id="subtitle">Doordeweeks overzicht</p>
        </div>
      </div>

      <div class="chips">
        <div class="chip"><span class="dot good" id="dotLive"></span><span id="clock">--:--</span></div>
        <div class="chip"><span class="dot"></span><span id="today">--</span></div>
        <div class="chip"><span class="dot warn"></span><span id="weekday">--</span></div>
        <div class="chip"><span class="dot" id="dotEdit"></span><span id="modeLabel">View</span></div>
      </div>

      <div class="btnrow">
        <button class="primary" id="toggleEdit">Bewerken</button>
        <button id="saveBtn">Opslaan</button>
        <button class="danger" id="resetBtn">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="panel">
        <div class="panel-h">
          <div>
            <h2>Vandaag</h2>
            <div class="hint">Diensten • pakketjes • bevoorrading • roosteraanpassingen • THT</div>
          </div>
          <div class="chips">
            <span class="badge" id="dateBadge">Datum: —</span>
            <span class="badge" id="teamBadge">Team: —</span>
          </div>
        </div>

        <div class="panel-b">
          <div class="kpi" id="kpiRow"></div>

          <!-- Diensten -->
          <div style="margin-top:14px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
              <h3 style="margin:0;">Diensten & bezetting</h3>
              <span class="hint">Dienst + code • medewerkers • tijd (OK-3 & MD starten 07:00)</span>
            </div>
            <div class="twrap" style="margin-top:10px;">
              <table>
                <thead>
                  <tr class="trow">
                    <th style="text-align:left;">Dienst</th>
                    <th style="text-align:left;">Medewerkers</th>
                    <th style="text-align:left;">Tijd</th>
                    <th style="text-align:left;">Opmerking</th>
                  </tr>
                </thead>
                <tbody id="serviceTable"></tbody>
              </table>
            </div>
          </div>

          <div class="twoCol" style="margin-top:14px;">
            <div>
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <h3 style="margin:0;">Roosteraanpassingen</h3>
                <span class="hint">Wie wisselt / valt uit / extra</span>
              </div>
              <div class="list" id="rosterList" style="margin-top:10px;"></div>
            </div>

            <div>
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                <h3 style="margin:0;">Actualiteiten / THT</h3>
                <span class="hint">Auto-sort: urgent bovenaan • rood ≤1 maand • oranje ≤3 maanden</span>
              </div>
              <div class="list" id="thtList" style="margin-top:10px;"></div>
            </div>
          </div>

          <!-- Editor main -->
          <div class="editor" id="editorMain">
            <div class="formgrid">
              <div>
                <label>Dashboard titel</label>
                <input id="inTitle" type="text" />
              </div>
              <div>
                <label>Subtitel</label>
                <input id="inSubtitle" type="text" />
              </div>
              <div>
                <label>Team label</label>
                <input id="inTeam" type="text" placeholder="bijv. Team IC / Team Logistiek" />
              </div>
              <div>
                <label>Datum (optioneel)</label>
                <input id="inDate" type="date" />
              </div>

              <div style="grid-column:1 / -1;">
                <label>
                  Diensten (1 per regel) — formaat:<br/>
                  <span style="font-family:var(--mono);">Code | Medewerker1, Medewerker2 | Tijd | Opmerking</span>
                </label>
                <div class="serviceHint">
                  Laat je <b>Tijd</b> leeg, dan vult het systeem automatisch in:
                  <b>OK-3</b> en <b>MD</b> → <b>07:00–15:30</b>, alles anders → <b>08:00–16:30</b>.
                </div>
                <div class="miniBtns" style="margin:10px 0 6px;">
                  <button class="mini" type="button" id="setTimeAuto">Zet tijd: auto</button>
                  <button class="mini" type="button" id="setTimeEarly">Zet tijd: 07:00–15:30</button>
                  <button class="mini" type="button" id="setTimeLate">Zet tijd: 08:00–16:30</button>
                </div>
                <textarea id="inServices"></textarea>
              </div>

              <div style="grid-column:1 / -1;">
                <label>
                  Roosteraanpassingen (1 per regel) — formaat:<br/>
                  <span style="font-family:var(--mono);">Wat | Owner (optioneel) | Status (good/warn/bad)</span>
                </label>
                <textarea id="inRoster"></textarea>
              </div>

              <div style="grid-column:1 / -1;">
                <label>
                  THT / Actualiteiten (1 per regel) — formaat:<br/>
                  <span style="font-family:var(--mono);">Item | THT (DD-MM-YYYY) | Opmerking (optioneel)</span><br/>
                  <span class="hint">Kleur + sortering wordt automatisch berekend o.b.v. THT.</span>
                </label>
                <textarea id="inTHT"></textarea>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="panel-h">
          <div>
            <h2>Logistiek</h2>
            <div class="hint">Pakketjes • bevoorrading • dienstenlijst</div>
          </div>
          <div class="chips">
            <span class="badge">Doordeweeks</span>
          </div>
        </div>

        <div class="panel-b">
          <div class="tile" id="pkgTile">
            <div class="label">Pakketjes vandaag</div>
            <div class="value" id="pkgValue">—</div>
            <div class="small" id="pkgSmall">Inkomend / uitgaand</div>
          </div>

          <div class="tile" id="supplyTile" style="margin-top:10px;">
            <div class="label">Bevoorrading</div>
            <div class="value" id="supplyValue">—</div>
            <div class="small" id="supplySmall">Leveringen / picks</div>
          </div>

          <div class="tile" id="notesTile" style="margin-top:10px;">
            <div class="label">Notities</div>
            <div class="small" id="notesView" style="white-space:pre-wrap; line-height:1.35;">—</div>
          </div>

          <div class="editor" id="editorSide">
            <div class="formgrid">
              <div>
                <label>Pakketjes (totaal)</label>
                <input id="inPkg" type="number" min="0" placeholder="bijv. 42" />
              </div>
              <div>
                <label>Pakketjes status</label>
                <select id="inPkgStatus">
                  <option value="">none</option>
                  <option value="good">good</option>
                  <option value="warn">warn</option>
                  <option value="bad">bad</option>
                </select>
              </div>
              <div>
                <label>Pakketjes detail</label>
                <input id="inPkgDetail" type="text" placeholder="bijv. 30 inkomend / 12 uitgaand" />
              </div>

              <div>
                <label>Bevoorrading (totaal)</label>
                <input id="inSupply" type="number" min="0" placeholder="bijv. 6" />
              </div>
              <div>
                <label>Bevoorrading status</label>
                <select id="inSupplyStatus">
                  <option value="">none</option>
                  <option value="good">good</option>
                  <option value="warn">warn</option>
                  <option value="bad">bad</option>
                </select>
              </div>
              <div>
                <label>Bevoorrading detail</label>
                <input id="inSupplyDetail" type="text" placeholder="bijv. 3 leveringen / 3 picks" />
              </div>

              <div style="grid-column:1 / -1;">
                <label>Notities (vrij tekstveld)</label>
                <textarea id="inNotes" placeholder="Wat moeten we vandaag niet vergeten?"></textarea>
              </div>
            </div>
          </div>

          <!-- Dienstenlijst -->
          <div class="panel" style="margin-top:12px; background: rgba(0,0,0,.12); box-shadow:none;">
            <div class="panel-h" style="background:transparent;">
              <div>
                <h2 style="font-size:15px;">Dienstenlijst (codes)</h2>
                <div class="hint">Zoek op naam of code</div>
              </div>
            </div>
            <div class="panel-b">
              <div class="search">
                <input id="svcSearch" type="text" placeholder="Zoek: OC, WKZ, UMC, OK-3, MD, IC-A, ..." />
              </div>
              <div class="list" id="svcList" style="margin-top:10px;"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="footer">
      <div>Opslaan gebeurt lokaal in de browser (localStorage). Handig op één vaste dagstart-PC/TV.</div>
      <div class="linklike" id="exportBtn">Export JSON</div>
    </div>
  </div>

<script>
  const LS_KEY = "dagstart_dashboard_weekdays_v3";

  // Diensten + codes (uit jouw lijst)
  const SERVICES = [
    { name:"OC vroeg", code:"OC-V" },
    { name:"OC ondersteuning", code:"OC-O" },

    { name:"WKZ - Panda/Papegaai", code:"W-PP" },
    { name:"WKZ - Kameleon/Schildpad", code:"W-KS" },
    { name:"WKZ - Verloskunde", code:"W-V" },
    { name:"WKZ - Zwangeren/Kraam", code:"W-ZK" },
    { name:"WKZ - Neonatologie", code:"W-N" },
    { name:"WKZ - Pelikaan/Leeuw", code:"W-PL" },
    { name:"WKZ - Overig", code:"W-Ov" },

    { name:"UMC - C2 west en D2 oost/west", code:"CD2" },
    { name:"UMC - C3 oost/west en D3 west", code:"CD3" },
    { name:"UMC - MDL/Dialyse", code:"MD" },
    { name:"UMC - D4 oost/west en D5 oost/west", code:"D45" },
    { name:"UMC - B3 oost/B3 west/CCU", code:"B3" },
    { name:"UMC - B4 oost/B4 west", code:"B4" },
    { name:"UMC - B2/B5", code:"B25" },
    { name:"UMC - C4/C5/D5", code:"CD45" },

    { name:"OK 1 (F.00)", code:"OK-1" },
    { name:"OK 2 (F.04)", code:"OK-2" },
    { name:"OK 3 (OMLOOP)", code:"OK-3" },
    { name:"OK 4 (WKZ)", code:"OK-4" },
    { name:"IC1", code:"IC-A" },
    { name:"IC2", code:"IC-B" },

    { name:"UMC - AB-B", code:"AB-B" },
    { name:"UMC - AB-C", code:"AB-C" },
    { name:"UMC - AB-D", code:"AB-D" },

    { name:"WKZ-Bode", code:"W-Bo" },
    { name:"UMC-Bode", code:"U-Bo" },
    { name:"UMC-Bode 2", code:"U-Bo2" },
    { name:"UMC-Bode 3", code:"U-Bo3" },
    { name:"Externe dienst en poli DIGD", code:"EXT" },
    { name:"Medische hulpmiddelen dienst", code:"MHS" },
    { name:"Projectmedewerker", code:"PROJ" },
    { name:"Inwerken", code:"INW" },
  ];

  const codeToName = new Map(SERVICES.map(s => [String(s.code).toUpperCase(), s.name]));

  // Default invulling (pas aan in bewerkmodus)
  const DEFAULT = {
    title: "Dagstart Dashboard",
    subtitle: "Doordeweeks overzicht",
    team: "Team —",
    date: "",

    packages: { total: "", status: "", detail: "—" },
    supply:   { total: "", status: "", detail: "—" },
    notes: "",

    // Code | Medewerkers | Tijd (mag leeg) | Opmerking
    services: [
      "OK-3 | |  |",
      "MD   | |  |",
      "CD2  | |  |",
    ],

    // Wat | Owner (opt) | good/warn/bad
    rosterChanges: [
      "Wissel: — | | warn"
    ],

    // Item | DD-MM-YYYY | Opmerking (opt)
    tht: [
      "Artikel X | 25-01-2026 |",
      "Artikel Y | 22-03-2026 |",
    ],
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return structuredClone(DEFAULT);
      const s = JSON.parse(raw);
      return { ...structuredClone(DEFAULT), ...s };
    }catch{
      return structuredClone(DEFAULT);
    }
  }
  function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

  function el(id){ return document.getElementById(id); }
  function setText(id, v){ el(id).textContent = v; }

  function parseLines(text){ return (text||"").split("\n").map(x=>x.trim()).filter(Boolean); }
  function safeStatus(s){
    s = (s||"").toLowerCase().trim();
    return (s==="good"||s==="warn"||s==="bad") ? s : "";
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#039;");
  }

  // --- THT: parse DD-MM-YYYY (en accepteer ook YYYY-MM-DD als fallback) ---
  function parseDateFlexible(s){
    s = (s || "").trim();
    if(!s) return null;

    // DD-MM-YYYY
    const dmy = /^(\d{2})-(\d{2})-(\d{4})$/;
    const m1 = s.match(dmy);
    if(m1){
      const dd = parseInt(m1[1], 10);
      const mm = parseInt(m1[2], 10);
      const yyyy = parseInt(m1[3], 10);
      const d = new Date(yyyy, mm - 1, dd);
      if(d.getFullYear() === yyyy && d.getMonth() === (mm - 1) && d.getDate() === dd) return d;
      return null;
    }

    // YYYY-MM-DD fallback
    const ymd = /^(\d{4})-(\d{2})-(\d{2})$/;
    const m2 = s.match(ymd);
    if(m2){
      const yyyy = parseInt(m2[1], 10);
      const mm = parseInt(m2[2], 10);
      const dd = parseInt(m2[3], 10);
      const d = new Date(yyyy, mm - 1, dd);
      if(d.getFullYear() === yyyy && d.getMonth() === (mm - 1) && d.getDate() === dd) return d;
      return null;
    }

    return null;
  }

  function thtStatus(dateStr){
    const d = parseDateFlexible(dateStr);
    if(!d) return { status:"warn", label:"ONGELDIGE DATUM", date:null };

    const today = new Date();
    today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);

    const diffDays = Math.floor((d.getTime() - today.getTime()) / (1000*60*60*24));

    if(diffDays < 0) return { status:"bad", label:`VERLOPEN (${Math.abs(diffDays)}d)`, date:d };
    if(diffDays <= 30) return { status:"bad", label:`≤1 maand (${diffDays}d)`, date:d };
    if(diffDays <= 90) return { status:"warn", label:`≤3 maanden (${diffDays}d)`, date:d };
    return { status:"good", label:`OK (${diffDays}d)`, date:d };
  }

  function mkBadge(text, status){
    const b = document.createElement("span");
    b.className = "badge " + (status || "");
    b.textContent = text || "—";
    return b;
  }

  // --- Diensttijden auto: OK-3 en MD vroeg, rest laat ---
  function defaultTimeForCode(code){
    const c = String(code || "").toUpperCase().trim();
    return (c === "OK-3" || c === "MD") ? "07:00–15:30" : "08:00–16:30";
  }

  function renderKPIs(state){
    const kpis = [
      { label:"Pakketjes", value: state.packages.total!=="" ? String(state.packages.total) : "—", status: safeStatus(state.packages.status), small: state.packages.detail || "" },
      { label:"Bevoorrading", value: state.supply.total!=="" ? String(state.supply.total) : "—", status: safeStatus(state.supply.status), small: state.supply.detail || "" },
      { label:"Rooster wijzigingen", value: String((state.rosterChanges||[]).length), status: ((state.rosterChanges||[]).length>0 ? "warn" : "good"), small: "Aantal items" }
    ];

    const row = el("kpiRow");
    row.innerHTML = "";
    kpis.forEach(k => {
      const tile = document.createElement("div");
      tile.className = "tile " + (k.status || "");
      tile.innerHTML = `
        <div class="label">${escapeHtml(k.label)}</div>
        <div class="value">${escapeHtml(k.value)}</div>
        <div class="small">${escapeHtml(k.small || " ")}</div>
      `;
      row.appendChild(tile);
    });
  }

  function renderServices(state){
    const tb = el("serviceTable");
    tb.innerHTML = "";

    (state.services||[]).forEach(line => {
      const parts = line.split("|").map(x=>x.trim());
      const rawCode = parts[0] || "—";
      const code = rawCode.toUpperCase();
      const svcName = codeToName.get(code) || "Onbekend";
      const names = parts[1] || "—";

      const rawTime = parts[2] || "";
      const time = rawTime ? rawTime : defaultTimeForCode(code);

      const note  = parts[3] || "—";

      const tr = document.createElement("tr");
      tr.className = "trow";
      tr.innerHTML = `
        <td>${escapeHtml(code)} <span style="color: var(--muted); font-weight:500;">• ${escapeHtml(svcName)}</span></td>
        <td style="color: var(--muted);">${escapeHtml(names)}</td>
        <td style="font-family: var(--mono);">${escapeHtml(time)}</td>
        <td style="color: var(--muted);">${escapeHtml(note)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function renderRoster(lines){
    const box = el("rosterList");
    box.innerHTML = "";
    (lines||[]).forEach(line => {
      const parts = line.split("|").map(x=>x.trim());
      const title = parts[0] || "—";
      const owner = parts[1] || "";
      const status = safeStatus(parts[2] || "");

      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `
        <p class="title">${escapeHtml(title)}</p>
        ${owner ? `<p class="meta">Owner: ${escapeHtml(owner)}</p>` : ``}
      `;

      const right = document.createElement("div");
      right.appendChild(mkBadge(status ? status.toUpperCase() : "—", status));

      item.appendChild(left);
      item.appendChild(right);
      box.appendChild(item);
    });
  }

  // THT: render + AUTO SORT (urgent bovenaan)
  function renderTHT(lines){
    const box = el("thtList");
    box.innerHTML = "";

    // Parse each line and compute status/date
    const parsed = (lines||[]).map((line, originalIndex) => {
      const parts = line.split("|").map(x=>x.trim());
      const itemName = parts[0] || "—";
      const dateStr  = parts[1] || "";
      const note     = parts[2] || "";
      const st = thtStatus(dateStr);

      // sortKey: invalid dates go last
      const sortKey = st.date ? st.date.getTime() : Number.POSITIVE_INFINITY;

      return { line, originalIndex, itemName, dateStr, note, st, sortKey };
    });

    // Sort by date asc (earliest first). Keep stable order for equal keys via originalIndex.
    parsed.sort((a,b) => (a.sortKey - b.sortKey) || (a.originalIndex - b.originalIndex));

    parsed.forEach(p => {
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `
        <p class="title">${escapeHtml(p.itemName)}</p>
        <p class="meta">THT: ${escapeHtml(p.dateStr || "—")}${p.note ? ` • ${escapeHtml(p.note)}` : ""}</p>
      `;

      const right = document.createElement("div");
      right.appendChild(mkBadge(p.st.label, p.st.status));

      item.appendChild(left);
      item.appendChild(right);
      box.appendChild(item);
    });
  }

  // Services directory search panel
  function renderServiceDirectory(query){
    const q = (query||"").toLowerCase().trim();
    const list = el("svcList");
    list.innerHTML = "";

    const filtered = SERVICES.filter(s => {
      if(!q) return true;
      return s.name.toLowerCase().includes(q) || s.code.toLowerCase().includes(q);
    }).slice(0, 60);

    filtered.forEach(s => {
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="left">
          <p class="title">${escapeHtml(s.name)}</p>
          <p class="meta">${escapeHtml(s.code)}</p>
        </div>
        <div>${mkBadge(s.code, "").outerHTML}</div>
      `;
      list.appendChild(item);
    });

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "Geen matches.";
      list.appendChild(empty);
    }
  }

  // UI state
  let state = loadState();
  let editMode = false;

  function applyStateToInputs(){
    el("inTitle").value = state.title;
    el("inSubtitle").value = state.subtitle;
    el("inTeam").value = state.team;
    el("inDate").value = state.date || "";

    el("inServices").value = (state.services||[]).join("\n");
    el("inRoster").value = (state.rosterChanges||[]).join("\n");
    el("inTHT").value = (state.tht||[]).join("\n");

    el("inPkg").value = state.packages.total;
    el("inPkgStatus").value = state.packages.status;
    el("inPkgDetail").value = state.packages.detail || "";

    el("inSupply").value = state.supply.total;
    el("inSupplyStatus").value = state.supply.status;
    el("inSupplyDetail").value = state.supply.detail || "";

    el("inNotes").value = state.notes || "";
  }

  function readInputsToState(){
    state.title = el("inTitle").value.trim() || DEFAULT.title;
    state.subtitle = el("inSubtitle").value.trim() || DEFAULT.subtitle;
    state.team = el("inTeam").value.trim() || DEFAULT.team;
    state.date = el("inDate").value || "";

    state.services = parseLines(el("inServices").value);
    state.rosterChanges = parseLines(el("inRoster").value);
    state.tht = parseLines(el("inTHT").value);

    state.packages = {
      total: el("inPkg").value === "" ? "" : Number(el("inPkg").value),
      status: safeStatus(el("inPkgStatus").value),
      detail: el("inPkgDetail").value.trim() || "—"
    };
    state.supply = {
      total: el("inSupply").value === "" ? "" : Number(el("inSupply").value),
      status: safeStatus(el("inSupplyStatus").value),
      detail: el("inSupplyDetail").value.trim() || "—"
    };
    state.notes = el("inNotes").value;
  }

  function render(){
    setText("title", state.title);
    setText("subtitle", state.subtitle);
    setText("teamBadge", `Team: ${state.team || "—"}`);

    const shownDate = state.date ? new Date(state.date + "T00:00:00") : new Date();
    setText("dateBadge", `Datum: ${shownDate.toLocaleDateString("nl-NL")}`);

    renderKPIs(state);
    renderServices(state);
    renderRoster(state.rosterChanges);
    renderTHT(state.tht);

    el("pkgTile").className = "tile " + safeStatus(state.packages.status);
    setText("pkgValue", state.packages.total !== "" ? String(state.packages.total) : "—");
    setText("pkgSmall", state.packages.detail || "—");

    el("supplyTile").className = "tile " + safeStatus(state.supply.status);
    setText("supplyValue", state.supply.total !== "" ? String(state.supply.total) : "—");
    setText("supplySmall", state.supply.detail || "—");

    el("notesView").textContent = state.notes ? state.notes : "—";

    el("editorMain").classList.toggle("on", editMode);
    el("editorSide").classList.toggle("on", editMode);
    setText("modeLabel", editMode ? "Edit" : "View");
    el("dotEdit").className = "dot " + (editMode ? "warn" : "");
  }

  function tick(){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    setText("clock", `${hh}:${mm}`);
    setText("today", now.toLocaleDateString("nl-NL", { year:"numeric", month:"long", day:"numeric" }));
    setText("weekday", now.toLocaleDateString("nl-NL", { weekday:"long" }));
    el("dotLive").className = "dot good";
  }

  // Buttons
  el("toggleEdit").addEventListener("click", () => {
    editMode = !editMode;
    if(editMode) applyStateToInputs();
    render();
  });

  el("saveBtn").addEventListener("click", () => {
    if(editMode) readInputsToState();
    saveState(state);
    render();
    alert("Opgeslagen op deze browser/pc ✅");
  });

  el("resetBtn").addEventListener("click", () => {
    if(confirm("Reset naar demo-inhoud?")){
      localStorage.removeItem(LS_KEY);
      state = loadState();
      editMode = false;
      render();
    }
  });

  el("exportBtn").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dagstart-dashboard.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  // Time helper buttons for editor
  function setTimeForEmptyLines(timeStr){
    const t = el("inServices");
    const lines = parseLines(t.value);
    const updated = lines.map(line => {
      const parts = line.split("|").map(x=>x.trim());
      const code = parts[0] || "";
      const names = parts[1] || "";
      const time = parts[2] || "";
      const note = parts[3] || "";
      const newTime = time ? time : timeStr;
      return `${code} | ${names} | ${newTime} | ${note}`;
    });
    t.value = updated.join("\n");
  }

  function setTimeAutoForEmptyLines(){
    const t = el("inServices");
    const lines = parseLines(t.value);
    const updated = lines.map(line => {
      const parts = line.split("|").map(x=>x.trim());
      const rawCode = parts[0] || "";
      const codeU = rawCode.toUpperCase();
      const names = parts[1] || "";
      const time = parts[2] || "";
      const note = parts[3] || "";
      const auto = defaultTimeForCode(codeU);
      const newTime = time ? time : auto;
      return `${rawCode} | ${names} | ${newTime} | ${note}`;
    });
    t.value = updated.join("\n");
  }

  el("setTimeAuto").addEventListener("click", () => setTimeAutoForEmptyLines());
  el("setTimeEarly").addEventListener("click", () => setTimeForEmptyLines("07:00–15:30"));
  el("setTimeLate").addEventListener("click", () => setTimeForEmptyLines("08:00–16:30"));

  // Service search
  el("svcSearch").addEventListener("input", (e) => renderServiceDirectory(e.target.value));

  // Init
  tick();
  setInterval(tick, 1000 * 10);
  renderServiceDirectory("");
  render();
</script>
</body>
</html>
